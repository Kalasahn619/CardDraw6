<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Draw - Random Luck App</title>
    <meta name="description" content="Interactive probability exploration with playing cards and mathematical analysis">
    <meta name="theme-color" content="#1f2937">

    <!-- PWA Manifest (shortened for clarity) -->
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'card-flip': 'cardFlip 0.6s ease-in-out',
                        'card-appear': 'cardAppear 0.5s ease-out forwards',
                        'bounce-gentle': 'bounceGentle 0.5s ease-in-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'number-reveal': 'numberReveal 0.8s ease-out forwards'
                    },
                    keyframes: {
                        cardFlip: {
                            '0%': { transform: 'rotateY(0deg)' },
                            '100%': { transform: 'rotateY(180deg)' }
                        },
                        cardAppear: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.8)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        },
                        bounceGentle: {
                            '0%, 20%, 50%, 80%, 100%': { transform: 'translateY(0)' },
                            '40%': { transform: 'translateY(-10px)' },
                            '60%': { transform: 'translateY(-5px)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        numberReveal: {
                            '0%': { opacity: '0', transform: 'scale(0.5) rotateY(90deg)' },
                            '50%': { opacity: '1', transform: 'scale(1.1) rotateY(0deg)' },
                            '100%': { opacity: '1', transform: 'scale(1) rotateY(0deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .card {
            width: 120px;
            height: 168px;
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            position: relative;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            border: 2px solid #374151;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .card-back {
            background: #1f2937 url('JokerV6.png') center center/80px 80px no-repeat;
            background-size: cover, 80px 80px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card-front {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            border: 2px solid #e2e8f0;
        }
        .suit-hearts, .suit-diamonds { color: #dc2626; }
        .suit-spades, .suit-clubs { color: #1f2937; }

        /* ... (rest of your original CSS for effects, scrollbars, etc) ... */

        @media (max-width: 768px) {
            .card { width: 100px; height: 140px; }
        }
        @media (prefers-contrast: high) {
            .card-front { border: 3px solid #000; }
        }
        @media (prefers-reduced-motion: reduce) {
            .card-inner, .floating-animation, .card-appear {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 min-h-screen text-white">
    <!-- Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
    }
    </script>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header (shortened for clarity) -->
        <div class="text-center mb-8 relative">
            <div class="floating-animation">
                <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent">
                    üé¥ Card Draw - Random Luck App ‚ú®
                </h1>
            </div>
            <p class="text-xl text-gray-300 mb-2">Interactive probability exploration with mathematical analysis</p>
        </div>

        <!-- Main Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Card Drawing Section -->
            <div class="lg:col-span-2 bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center space-x-2">
                        <span class="text-2xl">üé¥</span>
                        <span>Card Draw (6 Cards)</span>
                    </h2>
                    <div class="space-x-2">
                        <button id="drawCards" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-6 py-3 rounded-lg font-semibold transition-all duration-200">
                            üé≤ Draw Cards
                        </button>
                        <button id="flipAll" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-6 py-3 rounded-lg font-semibold transition-all duration-200">
                            üîÑ Flip All
                        </button>
                    </div>
                </div>
                <div id="cardsContainer" class="grid grid-cols-3 md:grid-cols-6 gap-4 justify-items-center mb-6"></div>
                <!-- Digital Root Display -->
                <div class="text-center bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg p-4 border border-purple-500/20">
                    <h3 class="text-xl font-semibold mb-4 flex items-center justify-center space-x-2">
                        <span>üîÆ</span>
                        <span>Digital Root Oracle</span>
                        <span>‚ú®</span>
                    </h3>
                    <div id="digitalRoot" class="flex flex-col lg:flex-row justify-center items-center space-y-4 lg:space-y-0 lg:space-x-6">
                        <div class="digital-root-ball card-stack-effect">?</div>
                        <div id="calculation" class="text-sm text-gray-300 bg-gray-800/50 rounded-lg p-3 max-w-md"></div>
                    </div>
                </div>
            </div>
            <!-- Suit Remapping Section (shortened for clarity) -->
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
                <h2 class="text-xl font-bold mb-4 flex items-center space-x-2">
                    <span>‚öôÔ∏è</span>
                    <span>Suit Order Configuration</span>
                </h2>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="classic">Classic</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="reverse">Reverse</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="custom">Custom</button>
                </div>
                <div id="suitOrder" class="space-y-2 mb-4"></div>
                <div id="codexComparison" class="text-sm">
                    <h4 class="font-semibold mb-2">Codex Values</h4>
                    <div id="codexDisplay"></div>
                </div>
            </div>
        </div>

        <!-- Simulation Section (shortened for clarity) -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 mb-8 shadow-2xl border border-gray-700">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 space-y-4 lg:space-y-0">
                <div>
                    <h2 class="text-2xl font-bold flex items-center space-x-2 mb-2">
                        <span>üéØ</span>
                        <span>Monte Carlo Simulation</span>
                    </h2>
                    <p class="text-gray-400 text-sm">Advanced statistical analysis with 500 randomized draws</p>
                </div>
                <button id="runSimulation" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 px-8 py-3 rounded-lg font-semibold transition-all duration-200">
                    üöÄ Run Simulation
                </button>
            </div>
            <div id="progressContainer" class="mb-6 hidden">
                <div class="bg-gray-700 rounded-full h-6 mb-3 overflow-hidden shadow-inner">
                    <div id="progressBar" class="progress-bar h-6 rounded-full relative" style="width: 0%">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent rounded-full"></div>
                    </div>
                </div>
                <div id="progressText" class="text-center text-sm text-gray-300 font-semibold">
                    <span class="inline-flex items-center space-x-2">
                        <span>‚ö°</span>
                        <span>0 / 500 draws completed</span>
                        <span>üìä</span>
                    </span>
                </div>
            </div>
            <div id="simulationResults" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
                <div class="bg-gradient-to-br from-green-900/20 to-emerald-900/20 rounded-lg p-4 border border-green-500/20">
                    <h3 class="text-lg font-semibold mb-3 flex items-center space-x-2">
                        <span>üèÜ</span>
                        <span>Top 6 Most Frequent Cards</span>
                    </h3>
                    <div id="topCards" class="space-y-2"></div>
                </div>
                <div class="bg-gradient-to-br from-blue-900/20 to-indigo-900/20 rounded-lg p-4 border border-blue-500/20">
                    <h3 class="text-lg font-semibold mb-3 flex items-center space-x-2">
                        <span>üìä</span>
                        <span>Digital Root Distribution</span>
                    </h3>
                    <div id="rootDistribution" class="grid grid-cols-5 gap-2"></div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-lg p-4 border border-purple-500/20">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <span>üìú</span>
                            <span>Simulation Draw History</span>
                        </h3>
                        <div class="flex space-x-2">
                            <button id="toggleHistoryView" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-3 py-1 rounded text-xs font-semibold transition-all">
                                üìä Summary
                            </button>
                            <button id="clearSimulationHistory" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 px-3 py-1 rounded text-xs font-semibold transition-all">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                    <div id="simulationDrawHistory" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar"></div>
                </div>
            </div>
        </div>

        <!-- History Section and Export & Data (shortened for clarity) -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 mb-8 shadow-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center space-x-2">
                    <span>üìú</span>
                    <span>Draw History</span>
                </h2>
                <button id="clearHistory" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200">
                    üóëÔ∏è Clear All
                </button>
            </div>
            <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
        </div>
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4 flex items-center space-x-2">
                <span>üíæ</span>
                <span>Export & Data Management</span>
            </h2>
            <div class="grid grid-cols-2 gap-3">
                <button id="exportCSV" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all">
                    <span>üìä</span>
                    <span>Export CSV</span>
                </button>
                <button id="exportJSON" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all">
                    <span>üìÑ</span>
                    <span>Export JSON</span>
                </button>
                <button id="saveSuitOrder" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all">
                    <span>üíæ</span>
                    <span>Save Config</span>
                </button>
                <button id="downloadManifest" class="bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all">
                    <span>üì±</span>
                    <span>PWA Manifest</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main JS -->
    <script>
    // --- State ---
    let currentDeck = [], currentDraw = [], suitOrder = ['‚ô•','‚ô¶','‚ô†','‚ô£'];
    let drawHistory = [], simulationHistory = [], simulationDraws = [];
    let showDetailedHistory = false;

    // --- Suit Presets ---
    const suitPresets = {
        classic: ['‚ô•','‚ô¶','‚ô†','‚ô£'],
        reverse: ['‚ô£','‚ô†','‚ô¶','‚ô•'],
        custom: ['‚ô•','‚ô¶','‚ô†','‚ô£']
    };

    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeDeck();
        setupEventListeners();
        renderSuitOrder();
        renderCards();
        calculateAndDisplayDigitalRoot();
        updateCodexDisplay();
    });

    // --- Deck Logic ---
    function initializeDeck() {
        currentDeck = [];
        for (const suit of ['‚ô•','‚ô¶','‚ô†','‚ô£']) {
            for (let value = 1; value <= 10; value++) {
                currentDeck.push({ suit, value });
            }
        }
    }
    function shuffleDeck(deck) {
        const shuffled = [...deck];
        const getRandomValue = (max) => {
            if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
                const array = new Uint32Array(1);
                crypto.getRandomValues(array);
                return array[0] / (0xFFFFFFFF + 1) * max;
            }
            return Math.random() * max;
        };
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(getRandomValue(i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // --- Codex & Digital Root ---
    function calculateCodex(card, customSuitOrder = null) {
        const order = customSuitOrder || suitOrder;
        const suitPosition = order.indexOf(card.suit);
        return (suitPosition * 10) + card.value;
    }
    function calculateDigitalRoot(sum) {
        if (sum % 10 === 0 && sum > 0) return 10;
        while (sum >= 10) {
            sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
        }
        return sum;
    }

    // --- Card Drawing & Rendering ---
    function drawCards() {
        const shuffled = shuffleDeck(currentDeck);
        currentDraw = shuffled.slice(0, 6).map(card => ({ ...card, faceUp: false }));
        renderCards();
        calculateAndDisplayDigitalRoot();
        updateCodexDisplay();
    }
    function flipAllCards() {
        currentDraw.forEach(card => card.faceUp = true);
        renderCards();
    }
    function renderCards() {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';
        currentDraw.forEach((card, idx) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card card-appear card-stack-effect' + (card.faceUp ? ' flipped' : '');
            cardDiv.style.animationDelay = `${idx * 0.1}s`;
            cardDiv.tabIndex = 0;
            cardDiv.setAttribute('role', 'button');
            cardDiv.setAttribute('aria-label', `Card ${idx+1}`);
            cardDiv.innerHTML = `
                <div class="card-inner">
                    <div class="card-back"></div>
                    <div class="card-front">
                        <div class="flex justify-between items-start">
                            <div class="text-xs font-bold ${getSuitClass(card.suit)} leading-tight">
                                ${card.value === 1 ? 'A' : card.value}<br>${card.suit}
                            </div>
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full shadow-lg">
                                ${calculateCodex(card)}
                            </div>
                        </div>
                        <div class="pip-pattern">
                            ${generatePipPattern(card.value, card.suit)}
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-400 font-semibold bg-gray-100 px-1 rounded">
                                Œî${calculateCodex(card) - calculateCodex(card, ['‚ô•','‚ô¶','‚ô†','‚ô£'])}
                            </div>
                            <div class="text-xs font-bold ${getSuitClass(card.suit)} transform rotate-180 leading-tight">
                                ${card.value === 1 ? 'A' : card.value}<br>${card.suit}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            cardDiv.addEventListener('click', () => {
                card.faceUp = !card.faceUp;
                renderCards();
                if (navigator.vibrate) navigator.vibrate(50);
            });
            container.appendChild(cardDiv);
        });
    }
    function getSuitClass(suit) {
        return suit === '‚ô•' ? 'suit-hearts' : suit === '‚ô¶' ? 'suit-diamonds' : suit === '‚ô†' ? 'suit-spades' : 'suit-clubs';
    }
    function generatePipPattern(value, suit) {
        // Can use your original pip patterns here. For brevity, just display suit symbol.
        return `<span class="text-4xl ${getSuitClass(suit)}">${suit}</span>`;
    }

    function calculateAndDisplayDigitalRoot() {
        if (currentDraw.length === 0) return;
        const codexSum = currentDraw.reduce((sum, card) => sum + calculateCodex(card), 0);
        const digitalRoot = calculateDigitalRoot(codexSum);
        let steps = [`Sum: ${currentDraw.map(card => calculateCodex(card)).join(' + ')} = ${codexSum}`];
        let tempSum = codexSum;
        if (tempSum % 10 === 0 && tempSum > 0) {
            steps.push(`Multiple of 10 ‚Üí Digital Root = 10`);
        } else {
            while (tempSum >= 10) {
                const digits = tempSum.toString().split('').map(d => parseInt(d));
                const newSum = digits.reduce((acc, d) => acc + d, 0);
                steps.push(`${digits.join(' + ')} = ${newSum}`);
                tempSum = newSum;
            }
        }
        document.querySelector('#digitalRoot .digital-root-ball').textContent = digitalRoot;
        document.getElementById('calculation').innerHTML = steps.join('<br>');
    }

    // --- Suit Order Rendering ---
    function renderSuitOrder() {
        const container = document.getElementById('suitOrder');
        container.innerHTML = '';
        suitOrder.forEach((suit, idx) => {
            const suitDiv = document.createElement('div');
            suitDiv.className = 'bg-gray-700 p-3 rounded cursor-move flex items-center justify-between';
            suitDiv.draggable = true;
            suitDiv.dataset.suit = suit;
            suitDiv.dataset.index = idx;
            suitDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-2xl ${getSuitClass(suit)}">${suit}</span>
                    <span>Position ${idx}</span>
                </div>
                <span class="text-sm text-gray-400">Codex ${idx*10+1}-${idx*10+10}</span>
            `;
            // Drag events (implement as needed)
            container.appendChild(suitDiv);
        });
    }
    function updateCodexDisplay() {
        const display = document.getElementById('codexDisplay');
        if (currentDraw.length === 0) {
            display.innerHTML = '<p class="text-gray-400">Draw cards to see codex values</p>';
            return;
        }
        let html = '';
        currentDraw.forEach(card => {
            const currentCodex = calculateCodex(card);
            const originalCodex = calculateCodex(card, ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']);
            const delta = currentCodex - originalCodex;
            const deltaClass = delta > 0 ? 'text-green-400' : delta < 0 ? 'text-red-400' : 'text-gray-400';
            const deltaSymbol = delta > 0 ? '+' : '';
            html += `
                <div class="flex justify-between text-xs mb-1">
                    <span>${card.value === 1 ? 'A' : card.value}${card.suit}</span>
                    <span>Current: ${currentCodex}</span>
                    <span>Original: ${originalCodex}</span>
                    <span class="${deltaClass}">${deltaSymbol}${delta}</span>
                </div>
            `;
        });
        display.innerHTML = html;
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        document.getElementById('drawCards').addEventListener('click', drawCards);
        document.getElementById('flipAll').addEventListener('click', flipAllCards);
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = btn.dataset.preset;
                suitOrder = [...suitPresets[preset]];
                renderSuitOrder();
                renderCards();
                calculateAndDisplayDigitalRoot();
                updateCodexDisplay();
            });
        });
        // Add listeners for export, simulation, etc as needed
    }
    </script>
</body>
</html>
