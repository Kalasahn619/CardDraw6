<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Draw - Random Luck App</title>
  <meta name="description" content="Interactive probability exploration with playing cards and mathematical analysis">
  <meta name="theme-color" content="#1f2937">
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FyZCBEcmF3IC0gUmFuZG9tIEx1Y2sgQXBwIiwic2hvcnRfbmFtZSI6IkNhcmQgRHJhdyIsImRlc2NyaXB0aW9uIjoiSW50ZXJhY3RpdmUgcHJvYmFiaWxpdHkgZXhwbG9yYXRpb24gd2l0aCBwbGF5aW5nIGNhcmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxZjI5MzciLCJ0aGVtZV9jb2xvciI6IiMxZjI5MzciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRreUlpQm9aV2xuYUhROUlqRTVNaUlnZG1sbGQwSnZlRDBpTUNBd0lERTVNaUF4T1RJaUlHWnBiR3c5SWlNeE9USTVOVGNpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhKbFkzUWdkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0l4T1RJaUlISjRQU0l4TmlJZ1ptbHNiRDBpSXpFNU1qazFOeUl2UGp3dmMzWm5QZz09Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'card-flip': 'cardFlip 0.6s ease-in-out',
            'card-appear': 'cardAppear 0.5s ease-out forwards',
            'bounce-gentle': 'bounceGentle 0.5s ease-in-out',
            'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'shimmer': 'shimmer 2s linear infinite'
          },
          keyframes: {
            cardFlip: {
              '0%': { transform: 'rotateY(0deg)' },
              '100%': { transform: 'rotateY(180deg)' }
            },
            cardAppear: {
              '0%': { opacity: '0', transform: 'translateY(20px) scale(0.8)' },
              '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
            },
            bounceGentle: {
              '0%, 20%, 50%, 80%, 100%': { transform: 'translateY(0)' },
              '40%': { transform: 'translateY(-10px)' },
              '60%': { transform: 'translateY(-5px)' }
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Card styles not covered by Tailwind */
    .card { perspective: 1000px; width: 120px; height: 168px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4,0,0.2,1); transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; border: 2px solid #374151; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .card-back { background: linear-gradient(135deg,#1f2937 0%,#374151 50%,#1f2937 100%); background-size: cover; background-position: center; background-repeat: no-repeat;}
    .card-front { background: linear-gradient(135deg,#fff 0%,#f8fafc 100%); transform: rotateY(180deg); display: flex; flex-direction: column; justify-content: space-between; padding: 8px; border: 2px solid #e2e8f0; }
    .suit-hearts, .suit-diamonds { color: #dc2626; }
    .suit-spades, .suit-clubs { color: #1f2937; }
    .pip-pattern { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
    .dragging { opacity: 0.6; transform: rotate(8deg) scale(1.05); z-index: 1000; }
    .drop-zone { border: 2px dashed #3b82f6; background: linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.2)); }
    .digital-root-ball {
      width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg,#fbbf24 0%,#f59e0b 50%,#d97706 100%);
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(251,191,36,0.4), inset 0 2px 4px rgba(255,255,255,0.3), inset 0 -2px 4px rgba(0,0,0,0.2); position: relative;
    }
    .digital-root-ball::before {
      content: ''; position: absolute; top: 15%; left: 20%; width: 20px; height: 15px; background: radial-gradient(ellipse,rgba(255,255,255,0.6) 0%,transparent 70%);
      border-radius: 50%; transform: rotate(-45deg);
    }
    .progress-bar { transition: width 0.3s cubic-bezier(0.4,0,0.2,1); background: linear-gradient(90deg,#8b5cf6,#a855f7,#c084fc,#e879f9); background-size:200% 100%; }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(135deg,#6366f1,#8b5cf6); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg,#4f46e5,#7c3aed); }
    @media (max-width:768px){.card{width:100px;height:140px;}}
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 min-h-screen text-white">
  <script>
    // Service Worker Registration for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <header class="text-center mb-8 relative">
      <div class="floating-animation">
        <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent">üé¥ Card Draw - Random Luck App ‚ú®</h1>
      </div>
      <p class="text-xl text-gray-300 mb-2">Interactive probability exploration with mathematical analysis</p>
      <div class="flex justify-center items-center space-x-4 text-sm text-gray-400">
        <span class="flex items-center space-x-1"><span>üéØ</span><span>Probability Research</span></span>
        <span class="flex items-center space-x-1"><span>üîÆ</span><span>Digital Divination</span></span>
        <span class="flex items-center space-x-1"><span>üìä</span><span>Statistical Analysis</span></span>
        <span class="flex items-center space-x-1"><span>üé≤</span><span>Educational Tool</span></span>
      </div>
    </header>
    <main>
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Card Drawing -->
        <div class="lg:col-span-2 bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold flex items-center space-x-2">
              <span class="text-2xl">üé¥</span>
              <span>Card Draw (6 Cards)</span>
            </h2>
            <div class="space-x-2">
              <button id="drawCards" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">üé≤ Draw Cards</button>
              <button id="flipAll" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">üîÑ Flip All</button>
            </div>
          </div>
          <div id="cardsContainer" class="grid grid-cols-3 md:grid-cols-6 gap-4 justify-items-center mb-6"></div>
          <div class="text-center bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg p-4 border border-purple-500/20">
            <h3 class="text-xl font-semibold mb-4 flex items-center justify-center space-x-2">
              <span>üîÆ</span><span>Digital Root Oracle</span><span>‚ú®</span>
            </h3>
            <div id="digitalRoot" class="flex flex-col lg:flex-row justify-center items-center space-y-4 lg:space-y-0 lg:space-x-6">
              <div class="digital-root-ball card-stack-effect">?</div>
              <div id="calculation" class="text-sm text-gray-300 bg-gray-800/50 rounded-lg p-3 max-w-md"></div>
            </div>
          </div>
        </div>
        <!-- Suit Remapping -->
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
          <h2 class="text-xl font-bold mb-4 flex items-center space-x-2"><span>‚öôÔ∏è</span><span>Suit Order Configuration</span></h2>
          <div class="grid grid-cols-3 gap-2 mb-4">
            <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="classic">Classic</button>
            <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="reverse">Reverse</button>
            <button class="preset-btn bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm transition-colors" data-preset="custom">Custom</button>
          </div>
          <div id="suitOrder" class="space-y-2 mb-4"></div>
          <div id="codexComparison" class="text-sm">
            <h4 class="font-semibold mb-2">Codex Values</h4>
            <div id="codexDisplay"></div>
          </div>
        </div>
      </section>
      <!-- Simulation -->
      <section class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 mb-8 shadow-2xl border border-gray-700">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 space-y-4 lg:space-y-0">
          <div>
            <h2 class="text-2xl font-bold flex items-center space-x-2 mb-2"><span>üéØ</span><span>Monte Carlo Simulation</span></h2>
            <p class="text-gray-400 text-sm">Advanced statistical analysis with 500 randomized draws</p>
          </div>
          <button id="runSimulation" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 px-8 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg glow-effect">üöÄ Run Simulation</button>
        </div>
        <div id="progressContainer" class="mb-6 hidden">
          <div class="bg-gray-700 rounded-full h-6 mb-3 overflow-hidden shadow-inner">
            <div id="progressBar" class="progress-bar h-6 rounded-full relative" style="width: 0%">
              <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent rounded-full"></div>
            </div>
          </div>
          <div id="progressText" class="text-center text-sm text-gray-300 font-semibold"></div>
        </div>
        <div id="simulationResults" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
          <div class="bg-gradient-to-br from-green-900/20 to-emerald-900/20 rounded-lg p-4 border border-green-500/20">
            <h3 class="text-lg font-semibold mb-3 flex items-center space-x-2"><span>üèÜ</span><span>Top 6 Most Frequent Cards</span></h3>
            <div id="topCards" class="space-y-2"></div>
          </div>
          <div class="bg-gradient-to-br from-blue-900/20 to-indigo-900/20 rounded-lg p-4 border border-blue-500/20">
            <h3 class="text-lg font-semibold mb-3 flex items-center space-x-2"><span>üìä</span><span>Digital Root Distribution</span></h3>
            <div id="rootDistribution" class="grid grid-cols-5 gap-2"></div>
          </div>
          <div class="bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-lg p-4 border border-purple-500/20">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-lg font-semibold flex items-center space-x-2"><span>üìú</span><span>Simulation Draw History</span></h3>
              <div class="flex space-x-2">
                <button id="toggleHistoryView" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-3 py-1 rounded text-xs font-semibold transition-all duration-200 transform hover:scale-105">üìä Summary</button>
                <button id="clearSimulationHistory" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 px-3 py-1 rounded text-xs font-semibold transition-all duration-200 transform hover:scale-105">üóëÔ∏è Clear</button>
              </div>
            </div>
            <div id="simulationDrawHistory" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar"></div>
          </div>
        </div>
      </section>
      <!-- History Section -->
      <section class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 mb-8 shadow-2xl border border-gray-700">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold flex items-center space-x-2"><span>üìú</span><span>Draw History</span></h2>
          <button id="clearHistory" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 transform hover:scale-105">üóëÔ∏è Clear All</button>
        </div>
        <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
      </section>
      <!-- Export & Data Section -->
      <section class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 shadow-2xl border border-gray-700">
        <h2 class="text-xl font-bold mb-4 flex items-center space-x-2"><span>üíæ</span><span>Export & Data Management</span></h2>
        <div class="grid grid-cols-2 gap-3">
          <button id="exportCSV" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-1"><span>üìä</span><span>Export CSV</span></button>
          <button id="exportJSON" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-1"><span>üìÑ</span><span>Export JSON</span></button>
          <button id="saveSuitOrder" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-1"><span>üíæ</span><span>Save Config</span></button>
          <button id="downloadManifest" class="bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-1"><span>üì±</span><span>PWA Manifest</span></button>
        </div>
      </section>
    </main>
  </div>
  <!-- App Logic -->
  <script>
    // --- GLOBAL STATE ---
    let currentDeck = [];
    let currentDraw = [];
    let suitOrder = ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
    let drawHistory = [];
    let simulationHistory = [];
    let simulationData = null;
    let simulationDraws = [];
    let showDetailedHistory = false;

    const suitPresets = {
      classic: ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'],
      reverse: ['‚ô£', '‚ô†', '‚ô¶', '‚ô•'],
      custom: ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']
    };

    // --- APP INIT ---
    document.addEventListener('DOMContentLoaded', function() {
      loadFromStorage();
      initializeDeck();
      setupEventListeners();
      renderSuitOrder();
      updateCodexDisplay();
    });

    // --- DECK LOGIC ---
    function shuffleDeck(deck) {
      const shuffled = [...deck];
      const getRandomValue = (max) => {
        if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
          const array = new Uint32Array(1);
          crypto.getRandomValues(array);
          return array[0] / (0xFFFFFFFF + 1) * max;
        }
        return Math.random() * max;
      };
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(getRandomValue(i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function initializeDeck() {
      currentDeck = [];
      const suits = ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
      for (let suit of suits) {
        for (let value = 1; value <= 10; value++) {
          currentDeck.push({ suit, value });
        }
      }
    }

    function calculateCodex(card, customSuitOrder = null) {
      const order = customSuitOrder || suitOrder;
      const suitPosition = order.indexOf(card.suit);
      return (suitPosition * 10) + card.value;
    }

    function calculateDigitalRoot(sum) {
      if (sum % 10 === 0 && sum > 0) return 10;
      while (sum >= 10) {
        sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
      }
      return sum;
    }

    // --- CARD RENDERING ---
    function generatePipPattern(value, suit) {
      const suitClass = `suit-${suit === '‚ô•' ? 'hearts' : suit === '‚ô¶' ? 'diamonds' : suit === '‚ô†' ? 'spades' : 'clubs'}`;
      const patterns = {
        1: `<div class="text-4xl ${suitClass}">${suit}</div>`,
        2: `<div class="flex flex-col justify-between h-full">
               <div class="text-2xl ${suitClass}">${suit}</div>
               <div class="text-2xl ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        3: `<div class="flex flex-col justify-between h-full py-1">
               <div class="text-lg ${suitClass}">${suit}</div>
               <div class="text-lg ${suitClass}">${suit}</div>
               <div class="text-lg ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        4: `<div class="grid grid-cols-2 gap-2 h-full">
               <div class="text-xl ${suitClass}">${suit}</div>
               <div class="text-xl ${suitClass}">${suit}</div>
               <div class="text-xl ${suitClass} transform rotate-180">${suit}</div>
               <div class="text-xl ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        5: `<div class="grid grid-cols-2 gap-1 h-full relative">
               <div class="text-lg ${suitClass}">${suit}</div>
               <div class="text-lg ${suitClass}">${suit}</div>
               <div class="absolute inset-0 flex items-center justify-center">
                 <div class="text-lg ${suitClass}">${suit}</div>
               </div>
               <div class="text-lg ${suitClass} transform rotate-180">${suit}</div>
               <div class="text-lg ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        6: `<div class="grid grid-cols-2 gap-1 h-full py-1">
               <div class="text-base ${suitClass}">${suit}</div>
               <div class="text-base ${suitClass}">${suit}</div>
               <div class="text-base ${suitClass}">${suit}</div>
               <div class="text-base ${suitClass}">${suit}</div>
               <div class="text-base ${suitClass} transform rotate-180">${suit}</div>
               <div class="text-base ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        7: `<div class="grid grid-cols-2 gap-1 h-full relative">
               <div class="text-sm ${suitClass}">${suit}</div>
               <div class="text-sm ${suitClass}">${suit}</div>
               <div class="text-sm ${suitClass}">${suit}</div>
               <div class="absolute top-1/4 left-1/2 transform -translate-x-1/2">
                 <div class="text-sm ${suitClass}">${suit}</div>
               </div>
               <div class="text-sm ${suitClass}">${suit}</div>
               <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
               <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
             </div>`,
        8: `<div class="grid grid-cols-2 gap-1 h-full">
              <div class="flex flex-col justify-between">
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
              </div>
              <div class="flex flex-col justify-between">
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
              </div>
            </div>`,
        9: `<div class="grid grid-cols-2 gap-1 h-full relative">
              <div class="flex flex-col justify-between">
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
              </div>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-sm ${suitClass}">${suit}</div>
              </div>
              <div class="flex flex-col justify-between">
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass}">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
                <div class="text-sm ${suitClass} transform rotate-180">${suit}</div>
              </div>
            </div>`,
        10: `<div class="grid grid-cols-2 gap-1 h-full">
                <div class="flex flex-col justify-between">
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass} transform rotate-180">${suit}</div>
                </div>
                <div class="flex flex-col justify-between">
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass}">${suit}</div>
                  <div class="text-xs ${suitClass} transform rotate-180">${suit}</div>
                  <div class="text-xs ${suitClass} transform rotate-180">${suit}</div>
                </div>
              </div>`
      };
      return patterns[value] || patterns[1];
    }

    function renderCards() {
      const container = document.getElementById('cardsContainer');
      const fragment = document.createDocumentFragment();
      container.innerHTML = '';
      currentDraw.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'card card-appear card-stack-effect';
        cardElement.style.animationDelay = `${index * 0.1}s`;
        cardElement.dataset.cardId = `${card.suit}-${card.value}`;
        const codex = calculateCodex(card);
        const originalCodex = calculateCodex(card, ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']);
        const delta = codex - originalCodex;
        const deltaClass = delta > 0 ? 'text-green-400' : delta < 0 ? 'text-red-400' : 'text-gray-400';
        const deltaSymbol = delta > 0 ? '+' : '';
        const suitClass = `suit-${card.suit === '‚ô•' ? 'hearts' : card.suit === '‚ô¶' ? 'diamonds' : card.suit === '‚ô†' ? 'spades' : 'clubs'}`;
        cardElement.innerHTML = `
          <div class="card-inner">
            <div class="card-back shimmer-effect"></div>
            <div class="card-front">
              <div class="flex justify-between items-start">
                <div class="text-xs font-bold ${suitClass} leading-tight">${card.value === 1 ? 'A' : card.value}<br>${card.suit}</div>
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full shadow-lg">${codex}</div>
              </div>
              <div class="pip-pattern">${generatePipPattern(card.value, card.suit)}</div>
              <div class="flex justify-between items-end">
                <div class="text-xs ${deltaClass} font-semibold bg-gray-100 px-1 rounded">${deltaSymbol}${delta}</div>
                <div class="text-xs font-bold ${suitClass} transform rotate-180 leading-tight">${card.value === 1 ? 'A' : card.value}<br>${card.suit}</div>
              </div>
            </div>
          </div>
        `;
        cardElement.addEventListener('click', () => {
          cardElement.classList.toggle('flipped');
          if (navigator.vibrate) navigator.vibrate(50);
        }, { passive: true });
        fragment.appendChild(cardElement);
      });
      container.appendChild(fragment);
    }

    function calculateAndDisplayDigitalRoot() {
      if (currentDraw.length === 0) return;
      const codexSum = currentDraw.reduce((sum, card) => sum + calculateCodex(card), 0);
      const digitalRoot = calculateDigitalRoot(codexSum);
      let steps = [`Sum: ${currentDraw.map(card => calculateCodex(card)).join(' + ')} = ${codexSum}`];
      let tempSum = codexSum;
      if (tempSum % 10 === 0 && tempSum > 0) {
        steps.push(`Multiple of 10 ‚Üí Digital Root = 10`);
      } else {
        while (tempSum >= 10) {
          const digits = tempSum.toString().split('').map(d => parseInt(d));
          const newSum = digits.reduce((acc, d) => acc + d, 0);
          steps.push(`${digits.join(' + ')} = ${newSum}`);
          tempSum = newSum;
        }
      }
      document.querySelector('#digitalRoot .digital-root-ball').textContent = digitalRoot;
      document.getElementById('calculation').innerHTML = steps.join('<br>');
    }

    // --- SUIT ORDER RENDERING ---
    function renderSuitOrder() {
      const container = document.getElementById('suitOrder');
      container.innerHTML = '';
      suitOrder.forEach((suit, index) => {
        const suitElement = document.createElement('div');
        suitElement.className = 'bg-gray-700 p-3 rounded cursor-move flex items-center justify-between';
        suitElement.draggable = true;
        suitElement.dataset.suit = suit;
        suitElement.dataset.index = index;
        const suitClass = `suit-${suit === '‚ô•' ? 'hearts' : suit === '‚ô¶' ? 'diamonds' : suit === '‚ô†' ? 'spades' : 'clubs'}`;
        suitElement.innerHTML = `
          <div class="flex items-center space-x-2">
            <span class="text-2xl ${suitClass}">${suit}</span>
            <span>Position ${index}</span>
          </div>
          <span class="text-sm text-gray-400">Codex ${index * 10 + 1}-${index * 10 + 10}</span>
        `;
        suitElement.addEventListener('dragstart', handleDragStart);
        suitElement.addEventListener('dragover', handleDragOver);
        suitElement.addEventListener('drop', handleDrop);
        suitElement.addEventListener('dragend', handleDragEnd);
        container.appendChild(suitElement);
      });
    }

    let draggedElement = null;
    function handleDragStart(e) { draggedElement = this; this.classList.add('dragging'); }
    function handleDragOver(e) { e.preventDefault(); this.classList.add('drop-zone'); }
    function handleDrop(e) {
      e.preventDefault(); this.classList.remove('drop-zone');
      if (draggedElement !== this) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        [suitOrder[draggedIndex], suitOrder[targetIndex]] = [suitOrder[targetIndex], suitOrder[draggedIndex]];
        renderSuitOrder(); updateCodexDisplay();
        if (currentDraw.length > 0) { renderCards(); calculateAndDisplayDigitalRoot(); }
        saveToStorage();
      }
    }
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.drop-zone').forEach(el => el.classList.remove('drop-zone'));
    }

    function updateCodexDisplay() {
      const display = document.getElementById('codexDisplay');
      if (currentDraw.length === 0) {
        display.innerHTML = '<p class="text-gray-400">Draw cards to see codex values</p>';
        return;
      }
      let html = '';
      currentDraw.forEach(card => {
        const currentCodex = calculateCodex(card);
        const originalCodex = calculateCodex(card, ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']);
        const delta = currentCodex - originalCodex;
        const deltaClass = delta > 0 ? 'text-green-400' : delta < 0 ? 'text-red-400' : 'text-gray-400';
        const deltaSymbol = delta > 0 ? '+' : '';
        html += `
          <div class="flex justify-between text-xs mb-1">
            <span>${card.value === 1 ? 'A' : card.value}${card.suit}</span>
            <span>Current: ${currentCodex}</span>
            <span>Original: ${originalCodex}</span>
            <span class="${deltaClass}">${deltaSymbol}${delta}</span>
          </div>
        `;
      });
      display.innerHTML = html;
    }

    // --- DRAWING CARDS ---
    function drawCards() {
      const shuffled = shuffleDeck(currentDeck);
      currentDraw = shuffled.slice(0, 6);
      const timestamp = new Date().toLocaleString();
      drawHistory.unshift({ cards: [...currentDraw], timestamp, suitOrder: [...suitOrder] });
      renderCards();
      calculateAndDisplayDigitalRoot();
      updateHistory();
      saveToStorage();
    }

    // --- HISTORY ---
    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      drawHistory.slice(0,10).forEach((entry, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 transition-colors';
        const cards = entry.cards.map(card => `${card.value === 1 ? 'A' : card.value}${card.suit}`).join(' ');
        const codexSum = entry.cards.reduce((sum, card) => sum + calculateCodex(card, entry.suitOrder), 0);
        const digitalRoot = calculateDigitalRoot(codexSum);
        historyItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="text-sm font-semibold">${cards}</div>
              <div class="text-xs text-gray-400">${entry.timestamp}</div>
            </div>
            <div class="text-right">
              <div class="text-sm">Root: ${digitalRoot}</div>
              <div class="text-xs text-gray-400">Sum: ${codexSum}</div>
            </div>
          </div>
        `;
        historyItem.addEventListener('click', () => {
          currentDraw = [...entry.cards];
          suitOrder = [...entry.suitOrder];
          renderSuitOrder();
          renderCards();
          calculateAndDisplayDigitalRoot();
          updateCodexDisplay();
        });
        historyList.appendChild(historyItem);
      });
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
      document.getElementById('drawCards').addEventListener('click', drawCards);
      document.getElementById('flipAll').addEventListener('click', () => {
        document.querySelectorAll('.card').forEach(card => card.classList.add('flipped'));
      });
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const preset = btn.dataset.preset;
          suitOrder = [...suitPresets[preset]];
          renderSuitOrder();
          updateCodexDisplay();
          if (currentDraw.length > 0) { renderCards(); calculateAndDisplayDigitalRoot(); }
          saveToStorage();
        });
      });
      document.getElementById('runSimulation').addEventListener('click', runSimulation);
      document.getElementById('clearHistory').addEventListener('click', () => {
        drawHistory = [];
        simulationHistory = [];
        simulationDraws = [];
        updateHistory();
        saveToStorage();
      });
      document.getElementById('clearSimulationHistory').addEventListener('click', () => {
        if (confirm('Clear simulation draw history? This will remove all simulation data but keep your manual draws.')) {
          simulationHistory = [];
          simulationDraws = [];
          simulationData = null;
          document.getElementById('simulationDrawHistory').innerHTML = '<div class="text-center text-gray-400 py-8">No simulation data available. Run a simulation to see draw history.</div>';
          document.getElementById('simulationResults').classList.add('hidden');
          saveToStorage();
        }
      });
      document.getElementById('toggleHistoryView').addEventListener('click', () => {
        showDetailedHistory = !showDetailedHistory;
        const button = document.getElementById('toggleHistoryView');
        button.innerHTML = showDetailedHistory ? 'üìä Summary' : 'üìã Detailed';
        displaySimulationDrawHistory();
      });
      document.getElementById('exportCSV').addEventListener('click', exportCSV);
      document.getElementById('exportJSON').addEventListener('click', exportJSON);
      document.getElementById('saveSuitOrder').addEventListener('click', saveSuitOrderConfig);
      document.getElementById('downloadManifest').addEventListener('click', downloadManifest);
    }

    // --- SIMULATION ---
    async function runSimulation() {
      const button = document.getElementById('runSimulation');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const resultsContainer = document.getElementById('simulationResults');
      button.disabled = true;
      button.innerHTML = '‚ö° Running Simulation...';
      button.classList.add('animate-pulse');
      progressContainer.classList.remove('hidden');
      resultsContainer.classList.add('hidden');
      const cardFrequency = new Map();
      const rootFrequency = new Map();
      const draws = 500;
      const startTime = performance.now();
      simulationDraws = [];
      for (let suit of ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']) { for (let value = 1; value <= 10; value++) { cardFrequency.set(`${value}${suit}`, 0); } }
      for (let i = 1; i <= 10; i++) { rootFrequency.set(i, 0); }
      const batchSize = 50;
      let completed = 0;
      const processBatch = async () => {
        const batchEnd = Math.min(completed + batchSize, draws);
        for (let i = completed; i < batchEnd; i++) {
          const shuffled = shuffleDeck(currentDeck);
          const draw = shuffled.slice(0, 6);
          const codexSum = draw.reduce((sum, card) => sum + calculateCodex(card), 0);
          const digitalRoot = calculateDigitalRoot(codexSum);
          const drawData = {
            drawNumber: i + 1,
            cards: draw.map(card => ({
              ...card,
              codex: calculateCodex(card),
              display: `${card.value === 1 ? 'A' : card.value}${card.suit}`
            })),
            codexSum,
            digitalRoot,
            timestamp: new Date().toLocaleString()
          };
          simulationDraws.push(drawData);
          draw.forEach(card => {
            const key = `${card.value}${card.suit}`;
            cardFrequency.set(key, cardFrequency.get(key) + 1);
          });
          rootFrequency.set(digitalRoot, rootFrequency.get(digitalRoot) + 1);
        }
        completed = batchEnd;
        const percentage = (completed / draws) * 100;
        progressBar.style.width = `${percentage}%`;
        progressText.innerHTML = `<span class="inline-flex items-center space-x-2"><span>‚ö°</span><span>${completed} / ${draws} draws completed</span><span>üìä</span></span>`;
        if (completed < draws) { await new Promise(resolve => requestAnimationFrame(resolve)); return processBatch(); }
      };
      await processBatch();
      const endTime = performance.now();
      const executionTime = ((endTime - startTime) / 1000).toFixed(2);
      const cardFrequencyObj = Object.fromEntries(cardFrequency);
      const rootFrequencyObj = Object.fromEntries(rootFrequency);
      simulationData = {
        cardFrequency: cardFrequencyObj,
        rootFrequency: rootFrequencyObj,
        draws: [...simulationDraws],
        timestamp: new Date().toLocaleString(),
        suitOrder: [...suitOrder],
        executionTime,
        totalDraws: draws,
        averageTimePerDraw: (executionTime / draws * 1000).toFixed(3) + 'ms'
      };
      simulationHistory.unshift(simulationData);
      await displaySimulationResults();
      displaySimulationDrawHistory();
      button.disabled = false;
      button.innerHTML = '‚úÖ Simulation Complete';
      button.classList.remove('animate-pulse');
      setTimeout(() => { button.innerHTML = 'üöÄ Run Simulation'; }, 2000);
      progressContainer.classList.add('hidden');
      resultsContainer.classList.remove('hidden');
      saveToStorage();
    }

    // --- SIM RESULT DISPLAY ---
    async function displaySimulationResults() {
      if (!simulationData) return;
      const { cardFrequency, rootFrequency, executionTime, averageTimePerDraw } = simulationData;
      // Top 6 cards display
      const topCardsContainer = document.getElementById('topCards');
      const sortedCards = Object.entries(cardFrequency).sort(([,a],[,b])=>b-a).slice(0,6);
      topCardsContainer.innerHTML = '';
      const metricsElement = document.createElement('div');
      metricsElement.className = 'bg-gradient-to-r from-blue-900/30 to-purple-900/30 p-2 rounded-lg mb-3 text-xs border border-blue-500/20';
      metricsElement.innerHTML = `<div class="flex justify-between items-center"><span>‚ö° Execution Time: ${executionTime}s</span><span>üéØ Avg/Draw: ${averageTimePerDraw}</span></div>`;
      topCardsContainer.appendChild(metricsElement);
      const cardGrid = document.createElement('div');
      cardGrid.className = 'grid grid-cols-3 md:grid-cols-6 gap-4 justify-items-center mb-4';
      for (let i = 0; i < sortedCards.length; i++) {
        const [cardStr, frequency] = sortedCards[i];
        const percentage = ((frequency/500)*100).toFixed(1);
        const expected = 7.5;
        const diff = (parseFloat(percentage)-expected).toFixed(1);
        const diffClass = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-400';
        const diffIcon = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚ûñ';
        const suit = cardStr.slice(-1);
        const valueStr = cardStr.slice(0, -1);
        const value = valueStr === 'A' ? 1 : parseInt(valueStr);
        const card = { suit, value };
        const codex = calculateCodex(card);
        const originalCodex = calculateCodex(card, ['‚ô•', '‚ô¶', '‚ô†', '‚ô£']);
        const delta = codex - originalCodex;
        const deltaClass = delta > 0 ? 'text-green-400' : delta < 0 ? 'text-red-400' : 'text-gray-400';
        const deltaSymbol = delta > 0 ? '+' : '';
        const suitClass = `suit-${suit === '‚ô•' ? 'hearts' : suit === '‚ô¶' ? 'diamonds' : suit === '‚ô†' ? 'spades' : 'clubs'}`;
        const cardElement = document.createElement('div');
        cardElement.className = 'card card-appear card-stack-effect flipped glow-effect';
        cardElement.style.animationDelay = `${i * 0.1}s`;
        cardElement.dataset.cardId = `${suit}-${value}`;
        cardElement.innerHTML = `
          <div class="card-inner">
            <div class="card-back shimmer-effect"></div>
            <div class="card-front">
              <div class="flex justify-between items-start">
                <div class="text-xs font-bold ${suitClass} leading-tight">${value === 1 ? 'A' : value}<br>${suit}</div>
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full shadow-lg">${codex}</div>
              </div>
              <div class="pip-pattern">${generatePipPattern(value, suit)}</div>
              <div class="flex justify-between items-end">
                <div class="text-xs ${deltaClass} font-semibold bg-gray-100 px-1 rounded">${deltaSymbol}${delta}</div>
                <div class="text-xs font-bold ${suitClass} transform rotate-180 leading-tight">${value === 1 ? 'A' : value}<br>${suit}</div>
              </div>
            </div>
          </div>
        `;
        cardGrid.appendChild(cardElement);
      }
      topCardsContainer.appendChild(cardGrid);
      // Stats summary
      const statsContainer = document.createElement('div');
      statsContainer.className = 'grid grid-cols-3 md:grid-cols-6 gap-2 text-center text-xs';
      for (let i = 0; i < sortedCards.length; i++) {
        const [cardStr, frequency] = sortedCards[i];
        const percentage = ((frequency/500)*100).toFixed(1);
        const expected = 7.5;
        const diff = (parseFloat(percentage)-expected).toFixed(1);
        const diffClass = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-400';
        const diffIcon = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚ûñ';
        const statElement = document.createElement('div');
        statElement.className = 'bg-gray-800/50 rounded-lg p-2 border border-gray-700';
        statElement.innerHTML = `
          <div class="font-bold text-white">#${i + 1}</div>
          <div class="font-semibold text-yellow-400">${frequency} times</div>
          <div class="text-gray-300">${percentage}%</div>
          <div class="${diffClass} flex items-center justify-center space-x-1 mt-1">
            <span>${diffIcon}</span>
            <span>${diff > 0 ? '+' : ''}${diff}%</span>
          </div>
        `;
        statsContainer.appendChild(statElement);
      }
      topCardsContainer.appendChild(statsContainer);
      // Digital root distribution
      const rootContainer = document.getElementById('rootDistribution');
      rootContainer.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const frequency = rootFrequency[i] || 0;
        const percentage = ((frequency/500)*100).toFixed(1);
        const isHighFreq = frequency > 50;
        const rootElement = document.createElement('div');
        rootElement.className = `text-center transform transition-all duration-300 hover:scale-110 ${isHighFreq ? 'glow-effect' : ''}`;
        rootElement.style.animationDelay = `${i * 0.05}s`;
        rootElement.innerHTML = `
          <div class="digital-root-ball mx-auto mb-2 ${isHighFreq ? 'animate-bounce-gentle' : ''}" style="width:45px;height:45px;font-size:18px;">${i}</div>
          <div class="text-xs">
            <div class="font-bold text-white">${frequency}</div>
            <div class="text-gray-400">${percentage}%</div>
            ${isHighFreq ? '<div class="text-yellow-400 text-xs">üî• Hot</div>' : ''}
          </div>
        `;
        rootContainer.appendChild(rootElement);
        setTimeout(() => { rootElement.classList.add('card-appear'); }, i * 50);
      }
    }

    function displaySimulationDrawHistory() {
      if (!simulationData) return;
      const historyContainer = document.getElementById('simulationDrawHistory');
      historyContainer.innerHTML = '';
      if (showDetailedHistory) {
        if (simulationDraws && simulationDraws.length > 0) {
          const recentDraws = simulationDraws.slice(-20).reverse();
          recentDraws.forEach((drawData, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 transition-colors';
            const cards = drawData.cards.map(card => card.display).join(' ');
            historyItem.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm font-semibold">${cards}</div>
                  <div class="text-xs text-gray-400">Draw #${drawData.drawNumber} - ${drawData.timestamp}</div>
                </div>
                <div class="text-right">
                  <div class="text-sm">Root: ${drawData.digitalRoot}</div>
                  <div class="text-xs text-gray-400">Sum: ${drawData.codexSum}</div>
                </div>
              </div>
            `;
            historyItem.addEventListener('click', () => {
              currentDraw = drawData.cards.map(card => ({ suit: card.suit, value: card.value }));
              renderCards();
              calculateAndDisplayDigitalRoot();
              updateCodexDisplay();
            });
            historyContainer.appendChild(historyItem);
          });
          if (simulationDraws.length > 20) {
            const infoElement = document.createElement('div');
            infoElement.className = 'text-center text-xs text-gray-400 py-2 border-t border-gray-600 mt-2';
            infoElement.innerHTML = `Showing last 20 of ${simulationDraws.length} draws. Click any draw to recreate it.`;
            historyContainer.appendChild(infoElement);
          }
        } else {
          historyContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No detailed draw data available.</div>';
        }
      } else {
        const { cardFrequency, rootFrequency } = simulationData;
        const topCards = Object.entries(cardFrequency).sort(([,a],[,b])=>b-a).slice(0,6);
        const topRoot = Object.entries(rootFrequency).sort(([,a],[,b])=>b-a)[0];
        const summaryElement = document.createElement('div');
        summaryElement.className = 'bg-gradient-to-r from-purple-900/50 to-pink-900/50 p-4 rounded-lg border border-purple-500/30';
        let topCardsHtml = '<div class="mb-4"><div class="text-sm font-semibold text-purple-200 mb-3 flex items-center space-x-2"><span>üèÜ</span><span>Top 6 Most Frequent Cards</span></div><div class="grid grid-cols-3 gap-2">';
        topCards.forEach(([cardStr, frequency], index) => {
          const percentage = ((frequency/500)*100).toFixed(1);
          const expected = 7.5;
          const diff = (parseFloat(percentage)-expected).toFixed(1);
          const diffClass = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-400';
          const diffIcon = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚ûñ';
          topCardsHtml += `
            <div class="bg-gray-800/50 rounded-lg p-2 text-center border border-gray-700">
              <div class="text-lg font-bold text-white mb-1">${cardStr}</div>
              <div class="text-xs text-yellow-400 font-semibold">${frequency} times</div>
              <div class="text-xs text-gray-300">${percentage}%</div>
              <div class="${diffClass} text-xs flex items-center justify-center space-x-1 mt-1"><span>${diffIcon}</span><span>${diff > 0 ? '+' : ''}${diff}%</span></div>
            </div>
          `;
        });
        topCardsHtml += '</div></div>';
        const rootPercentage = ((topRoot[1]/500)*100).toFixed(1);
        const topRootHtml = `
          <div class="mb-4">
            <div class="text-sm font-semibold text-purple-200 mb-3 flex items-center space-x-2"><span>üéØ</span><span>Most Frequent Digital Root</span></div>
            <div class="bg-gray-800/50 rounded-lg p-3 text-center border border-gray-700">
              <div class="digital-root-ball mx-auto mb-2" style="width:50px;height:50px;font-size:20px;">${topRoot[0]}</div>
              <div class="text-sm">
                <div class="font-bold text-white">${topRoot[1]} times</div>
                <div class="text-yellow-400 font-semibold">${rootPercentage}%</div>
                <div class="text-xs text-gray-400 mt-1">out of 500 draws</div>
              </div>
            </div>
          </div>
        `;
        const metricsHtml = `
          <div class="border-t border-purple-500/30 pt-3">
            <div class="text-sm font-semibold text-purple-200 mb-2 flex items-center space-x-2"><span>‚ö°</span><span>Simulation Performance</span></div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="text-gray-300">Total Draws: <span class="text-white font-semibold">${simulationData.totalDraws}</span></div>
              <div class="text-gray-300">Execution: <span class="text-white font-semibold">${simulationData.executionTime}s</span></div>
              <div class="text-gray-300">Avg/Draw: <span class="text-white font-semibold">${simulationData.averageTimePerDraw}</span></div>
              <div class="text-gray-300">Completed: <span class="text-white font-semibold">${simulationData.timestamp}</span></div>
            </div>
          </div>
        `;
        summaryElement.innerHTML = topCardsHtml + topRootHtml + metricsHtml;
        historyContainer.appendChild(summaryElement);
      }
    }

    // --- EXPORT ---
    function exportCSV() {
      if (!simulationData) { alert('Run a simulation first to export data'); return; }
      let csv = 'Card,Frequency,Percentage\n';
      Object.entries(simulationData.cardFrequency).forEach(([card, freq]) => {
        const percentage = ((freq/500)*100).toFixed(2);
        csv += `${card},${freq},${percentage}%\n`;
      });
      csv += '\nDigital Root,Frequency,Percentage\n';
      Object.entries(simulationData.rootFrequency).forEach(([root, freq]) => {
        const percentage = ((freq/500)*100).toFixed(2);
        csv += `${root},${freq},${percentage}%\n`;
      });
      if (simulationData && simulationData.draws && simulationData.draws.length > 0) {
        csv += '\nSimulation Draw History\n';
        csv += 'Draw Number,Cards,Codex Values,Codex Sum,Digital Root,Timestamp\n';
        simulationData.draws.forEach(draw => {
          const cardsStr = draw.cards.map(card => card.display).join(' ');
          const codexStr = draw.cards.map(card => card.codex).join(' ');
          csv += `${draw.drawNumber},"${cardsStr}","${codexStr}",${draw.codexSum},${draw.digitalRoot},${draw.timestamp}\n`;
        });
      }
      downloadFile(csv, 'lottery-analysis-data.csv', 'text/csv');
    }

    function exportJSON() {
      const data = { drawHistory, simulationHistory, currentSuitOrder: suitOrder, exportTimestamp: new Date().toISOString() };
      downloadFile(JSON.stringify(data, null, 2), 'card-draw-data.json', 'application/json');
    }

    function saveSuitOrderConfig() {
      const name = prompt('Enter a name for this suit order configuration:');
      if (name) {
        const savedConfigs = JSON.parse(localStorage.getItem('suitConfigs') || '{}');
        savedConfigs[name] = [...suitOrder];
        localStorage.setItem('suitConfigs', JSON.stringify(savedConfigs));
        alert(`Suit order "${name}" saved successfully!`);
      }
    }

    function downloadManifest() {
      const manifest = {
        name: "Card Draw - Random Luck App",
        short_name: "Card Draw",
        description: "Interactive probability exploration with playing cards",
        start_url: "/",
        display: "standalone",
        background_color: "#1f2937",
        theme_color: "#1f2937",
        icons: [{
          src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9IiMxOTI5NTciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIxNiIgZmlsbD0iIzE5Mjk1NyIvPjwvc3ZnPg==",
          sizes: "192x192",
          type: "image/svg+xml"
        }]
      };
      downloadFile(JSON.stringify(manifest, null, 2), 'manifest.json', 'application/json');
    }

    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- STORAGE ---
    function saveToStorage() {
      const data = { drawHistory, simulationHistory, suitOrder, currentDraw };
      localStorage.setItem('cardDrawApp', JSON.stringify(data));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem('cardDrawApp');
      if (saved) {
        const data = JSON.parse(saved);
        drawHistory = data.drawHistory || [];
        simulationHistory = data.simulationHistory || [];
        suitOrder = data.suitOrder || ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
        currentDraw = data.currentDraw || [];
        if (simulationHistory.length > 0) simulationData = simulationHistory[0];
        updateHistory();
        if (currentDraw.length > 0) { renderCards(); calculateAndDisplayDigitalRoot(); }
      }
    }

    // --- PWA INSTALL PROMPT ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBtn = document.createElement('button');
      installBtn.textContent = 'Install App';
      installBtn.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold transition-colors z-50';
      installBtn.addEventListener('click', () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') { console.log('User accepted the install prompt'); }
          deferredPrompt = null; installBtn.remove();
        });
      });
      document.body.appendChild(installBtn);
    });
  </script>
</body>
</html>
